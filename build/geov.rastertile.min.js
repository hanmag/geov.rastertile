!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("geov"),require("three")):"function"==typeof define&&define.amd?define(["exports","geov","three"],e):e(t.geov=t.geov||{},t.geov,t.THREE)}(this,function(t,e,i){"use strict";var n={},s=[],r=900;var a=function(t){var e,i,r=n[t];return r&&(e=t,(i=s.findIndex(function(t){return t===e}))<0||(s=s.concat(s.splice(i,1)))),r},o=function(t){!function(t){if(s.push(t),s.length>r)for(var e=0;e<.3*r;e++){var i=s.shift();n[i].dispose(),delete n[i]}}(t.id),n[t.id]=t},h=function(t){n[t.id]=t},l={setMapType:function(t){this.type=t},getTileUrl:function(t,e,i){switch(this.type){case"bing":return this._getBingTileUrl(t,e,i);default:return null}},_getBingTileUrl:function(t,i,n){var s=i,r=n.toString(2),a=s.toString(2),o=r.length-a.length,h=0;if(o>0)for(h=0;h<o;h++)a="0"+a;else if(o<0)for(o=-o,h=0;h<o;h++)r="0"+r;var l="";for(h=0;h<a.length;h++){l+=a[h]+r[h]}var u=e.MathUtils.numerationSystemTo10(2,l).toString(4);if(u.length<t)for(o=t-u.length,h=0;h<o;h++)u="0"+u;return"//ecn.t"+(t+i+n)%8+".tiles.virtualearth.net/tiles/a"+u+".jpeg?g=1239&mkt=en-us"}},u=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},c=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),f=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},d=function(){function t(i,n,s,r,a,o){u(this,t),this.id=n+"-"+r+"-"+a,this.radius=i,this.zoom=n,this.size=s,this.row=a,this.col=r,this.width=o,this.phiStart=0===a?0:e.MathUtils.HALFPI+Math.atan((2*a/s-1)*e.MathUtils.PI),this.height=a===s-1?e.MathUtils.PI-this.phiStart:e.MathUtils.HALFPI+Math.atan((2*(a+1)/s-1)*e.MathUtils.PI)-this.phiStart,this.url=l.getTileUrl(this.zoom,this.row,this.col)}return c(t,[{key:"load",value:function(){if(!this.state){this.request||(this.request=new XMLHttpRequest,this.request.timeout=1e4);var t=this;this.state="loading",this.request.open("GET",this.url,!0),this.request.responseType="blob",this.request.onload=function(){var n=this.response,s=document.createElement("img");s.onload=function(n){if(window.URL.revokeObjectURL(s.src),t.heightSegments=Math.max(12-t.zoom,5),t.widthSegments=t.zoom<5?12:3,t.geometry=new i.SphereBufferGeometry(t.radius,t.widthSegments,t.heightSegments,t.col*t.width,t.width,t.phiStart,t.height),t.zoom<12&&t.row>0&&t.row<t.size-1){t.geometry.removeAttribute("uv");for(var r=Math.tan(t.phiStart-e.MathUtils.HALFPI)/2,a=Math.tan(t.phiStart+t.height-e.MathUtils.HALFPI)/2,o=[],h=0;h<=t.heightSegments;h++)for(var l=t.phiStart+h/t.heightSegments*t.height,u=(a-Math.tan(l-e.MathUtils.HALFPI)/2)/(a-r),c=0;c<=t.widthSegments;c++)o.push(c/t.widthSegments),o.push(u);t.geometry.addAttribute("uv",new i.BufferAttribute(new Float32Array(o),2))}t.texture=new i.Texture,t.texture.image=s,t.texture.format=i.RGBFormat,t.texture.needsUpdate=!0,t.material=new i.MeshLambertMaterial({map:t.texture,side:i.FrontSide}),t.mesh=new i.Mesh(t.geometry,t.material),t.mesh.tileId=t.id,t.state="loaded"},s.src=window.URL.createObjectURL(n)},this.request.ontimeout=function(){t.state=null,console.warn("Tile [%s] time out",t.id)},this.request.onerror=function(){t.state=null},this.request.send()}}},{key:"abort",value:function(){this.request&&(this.request.abort(),this.request=null),this.state=null}},{key:"dispose",value:function(){this.abort(),this.geometry&&this.geometry.dispose(),this.geometry=null,this.material&&(this.material.dispose(),this.texture.dispose(),this.material=null,this.texture=null),this.mesh=null}}]),t}();function m(t,i,n){for(;n<0;)n+=e.MathUtils.PI2;var s;n%=e.MathUtils.PI2,i-=e.MathUtils.HALFPI,i=((s=i)<-e.MathUtils.MAXPHI?1e-5-e.MathUtils.HALFPI:s>e.MathUtils.MAXPHI?e.MathUtils.HALFPI-1e-5:Math.tan(s)/2)+e.MathUtils.HALFPI;var r=Math.pow(2,t),a=e.MathUtils.PI/r;return{z:t,s:r,c:Math.floor(n/(2*a)),r:Math.floor(i/a),w:2*a}}function p(t,e,i){var n=2*t,s=Math.floor(t/2);return e<0&&(e=-1-e,i+=s),(e=(e+n)%n)>t-1&&(e=n-e-1,i+=s),[e,i=(i+n)%t]}var g=function(){function t(e){u(this,t),this._radius=e}return c(t,[{key:"getVisibleTiles",value:function(t,e,i,n,s){var r=m(t,e,i),a=this._makeTile(r);return!(this._lastVisibleExtent&&a.id===this._lastVisibleExtent.id&&Math.abs(n-this._lastVisibleExtent.pitch)<.001&&Math.abs(s-this._lastVisibleExtent.bearing)<.001)&&(this._lastVisibleExtent={id:a.id,pitch:n,bearing:s},this.visibleTiles=this._makeRoundTiles(r,function(t,e,i){for(var n=2*Math.abs((t.row+.5)/t.size-.5),s=t.zoom<4?1:t.zoom/15,r=Math.min(90/(90-e),2)-1,a=.5+Math.cos(i)*(.5-(t.row+.5)/t.size),o=Math.round(1+2*s+4*n+4*r+1.2*a+1.2*Math.abs(Math.sin(i))),h=Math.round(1+2.5*s+4*n+3*r+1.2*a+1.2*Math.abs(Math.cos(i))),l=t.row,u=t.col,c=[[l,u]],f=[l+"-"+u],d=function(t){f.indexOf(t[0]+"-"+t[1])<0&&(f.push(t[0]+"-"+t[1]),c.push(t))},m=1;m<=Math.max(o,h);m++)for(var g=m;g>-1;g--)d(p(t.size,l+Math.min(o,m),u+Math.min(h,g))),d(p(t.size,l+Math.min(o,m),u-Math.min(h,g))),d(p(t.size,l-Math.min(o,m),u+Math.min(h,g))),d(p(t.size,l-Math.min(o,m),u-Math.min(h,g))),d(p(t.size,l+Math.min(o,g),u+Math.min(h,m))),d(p(t.size,l+Math.min(o,g),u-Math.min(h,m))),d(p(t.size,l-Math.min(o,g),u+Math.min(h,m))),d(p(t.size,l-Math.min(o,g),u-Math.min(h,m)));return c}(a,n,s)),this.visibleTiles)}},{key:"_makeTile",value:function(t){var e=t.z+"-"+t.c+"-"+t.r,i=a(e);return i||((i=new d(this._radius,t.z,t.s,t.c,t.r,t.w)).zoom<4?h(i):o(i)),i}},{key:"_makeRoundTiles",value:function(t,e){var i=this;return e.map(function(e){return i._makeTile({z:t.z,s:t.s,c:e[1],r:e[0],w:t.w})})}},{key:"isVisible",value:function(t){return this.visibleTiles&&this.visibleTiles.find(function(e){return e.id===t})}}]),t}(),M=function(t){function n(t,e){u(this,n);var s=f(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return s.tilesInScene={},s.group=new i.Group,l.setMapType(e.type),s}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(n,e.Layer),c(n,[{key:"load",value:function(){var t=this;this.tileGrid=new g(this.earth._radius),this.earth._scene.add(this.group),this.earth._controls.addEventListener("change",function(){return t._loadTiles()}),this.earth._controls.addEventListener("end",function(){return t._loadTiles(!0)}),this._loadTiles()}},{key:"_loadTiles",value:function(t){if(t||!this.needUpdate&&!this.inControl){this.inControl=!0;var e=this.earth.getZoom(),i=this.earth.getRadian(),n=this.earth.getPitch(),s=this.earth.getBearing(),r=this.tileGrid.getVisibleTiles(Math.round(Math.max(e+1,2)),i.y,i.x,n,s);if(r){if(this.tiles){var a=this;this.tiles.forEach(function(t){a.tileGrid.isVisible(t.id)||"loading"!==t.state||t.abort()})}this.tiles=r,this.needUpdate=!0}this.inControl=!1}}},{key:"update",value:function(){var t=this;if(this.needUpdate&&this.tiles){var e=0;if(this.tiles.forEach(function(t){"loading"===t.state?e++:t.state||(t.load(),e++)}),e<.2*this.tiles.length){this.tiles.forEach(function(e){t.tilesInScene[e.id]||"loaded"!==e.state||(t.group.add(e.mesh),t.tilesInScene[e.id]=e.mesh)});var i=this;Object.keys(this.tilesInScene).forEach(function(e){i.tileGrid.isVisible(e)||(t.group.remove(i.tilesInScene[e]),delete i.tilesInScene[e])})}this.needUpdate=e>0}}}]),n}();t.TileLayer=M,Object.defineProperty(t,"__esModule",{value:!0})});
